+++
title = 'Protobuf'
date = 2024-04-26T11:12:56+08:00
draft = true
+++

## [TLV](!https://en.wikipedia.org/wiki/Type%E2%80%93length%E2%80%93value)

在计算机科学领域中，TLV（Type-Length-Value）格式是一种常见的数据表示方式，它被广泛运用在各种通信协议和数据交换格式中。TLV 格式由三个部分组成：类型（Type）、长度（Length）和值（Value），它们一起构成了一种灵活且通用的数据结构。
### 1. 结构解析

#### 1.1 类型（Type）

类型字段表示所传输数据的类型或者命令。它通常由一个或多个字节组成，不同的协议或者应用可能会规定不同的类型编码方式。例如，某个协议中可能将文本消息的类型编码为 0x01，将图片消息的类型编码为 0x02。

#### 1.2 长度（Length）

长度字段表示值字段的长度，通常以字节为单位。它告诉接收方在解析数据时应该读取多少个字节作为值字段。长度字段的大小也可能是固定的，也可能是可变的，这取决于具体的协议设计。

#### 1.3 值（Value）

值字段承载了实际的数据内容。它的内容可以是任意的，根据类型字段的不同，值字段可能包含文本、数字、二进制数据等等。值字段的长度由长度字段指定，接收方根据长度字段读取对应长度的字节来获取值。

## Base 128 Varints
变宽整数，或称为 varints，它允许使用一到十个字节对无符号 64 位整数进行编码，较小的值使用较少的字节。

在 varint 中，每个字节都有一个标识位，指示接下来的字节是否属于 varint。这是字节的最高有效位（MSB）（有时也称为符号位）。较低的 7 位是有效载荷；最终的整数是通过连接其组成字节的 7 位有效载荷而构建的。

例如，这是数字 1，编码为 `01` - 这是一个字节，因此最高有效位未设置：
```
0000 0001
^ msb
```

这是数字 `150`，编码为 `0x9601` - 这有点复杂：

```
10010110 00000001
^ msb    ^ msb
```

如何确定这是 150？首先，从每个字节中删除最高有效位，因为这仅用于告诉我们是否已到达数字的结尾（正如您所见，由于 varint 中有多个字节，它在第一个字节中设置）。这些 7 位有效载荷按小端顺序排列。将其转换为大端顺序，进行串联，然后解释为无符号 64 位整数：

```
10010110 00000001 // 原始输入。
0010110 0000001 // 删除继续位。
0000001 0010110 // 转换为大端。
00000010010110 // 连接。
128 + 16 + 4 + 2 = 150 // 解释为无符号 64 位整数。
```

由于 varints 对于协议缓冲区非常重要，因此在 `protoscope` 语法中，我们将它们称为普通整数。`150` 与 `0x9601` 是相同的。